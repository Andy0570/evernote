## 第1章：OSI 参考模型

为了使不同计算机厂家生产的计算机能够相互通信，以便在更大的范围内建立计算机网络，国际标准化组织（ISO）在 1978 年提出了 “开放系统互联参考模型”，即著名的 OSI/RM 模型（Open System Interconnection/Reference Model）。它将计算机网络体系结构的通信协议划分为七层，自下而上依次为：物理层（Physics Layer）、数据链路层（Data Link Layer）、网络层（Network Layer）、传输层（Transport Layer）、会话层（Session Layer）、表示层（Presentation Layer）、应用层（Application Layer）。其中第四层完成数据传送服务，上面三层面向用户。

除了标准的 OSI 七层模型以外，常见的网络层次划分还有 TCP/IP 四层协议以及 TCP/IP 五层协议，它们之间的对应关系如下图所示：

![](https://i.loli.net/2020/12/09/vnNwM6mqekQ5XtT.jpg)

![](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/TCP-IP%20OSI%20%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B.png)

![](https://i.loli.net/2020/12/09/1syoWeA8it95I3F.gif)




### 应用层：应用程序

为**操作系统**或**应用程序**提供服务并规定应用程序中通信相关的细节。包括文件传输、电子邮件、远程登录（虚拟终端）等协议。

会话层、表示层和应用层重点：
1. 数据传输基本单位为**报文**；
2. 包含的主要协议：FTP（文件传送协议）、Telnet（远程登录协议）、DNS（域名解析协议）、SMTP（邮件传送协议），POP3 协议（邮局协议），HTTP 协议（Hyper Text Transfer Protocol）。


### 表示层：数据格式的转换

将应用处理的信息转换为适合网络传输的格式，或者将来自下一层的数据转换为上层能够处理的格式。因此它**主要负责数据格式的转换**。

具体来说，就是将**设备固有的数据格式**转换为**网络标准传输格式**。

表示层是进行“**统一的网络数据格式**”与“**某一台计算机或某一款软件特有的数据格式**”之间相互转换的分层。

表示层对上层数据或信息进行变换以保证一个主机应用层信息可以被另一个主机的应用程序理解。表示层的数据转换包括数据的加密、压缩、格式转换等。


### 会话层：建立连接、数据分割

负责**建立和断开通信连接**（数据流动的逻辑通信），以及**数据的分割**等数据传输相关的管理。

会话层管理主机之间的会话进程，即负责建立、管理、终止进程之间的会话。会话层还利用在数据中插入校验点来实现数据的同步。


### 传输层：可靠传输

在两台主机之间创建**逻辑上的通信连接**。起着**可靠传输**的作用。只在通信双方节点上进行处理，而无需在路由器上处理。

第一个端到端，即主机到主机的层次。**传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输**。此外，传输层还要处理端到端的差错控制和流量控制问题。

传输层的任务是根据通信子网的特性，最佳的利用网络资源，为两个端系统的会话层之间，提供建立、维护和取消传输连接的功能，负责端到端的可靠数据传输。

网络层只是根据网络地址将源结点发出的数据包传送到目的结点，而传输层则负责将数据可靠地传送到相应的端口。

有关传输层的重点：
1. 传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输以及端到端的差错控制和流量控制问题；
2. 在这一层，信息传送的协议数据单元称为**段**或**报文**。
3. 包含的主要协议：
    * TCP 协议（Transmission Control Protocol，传输控制协议）；
    * UDP 协议（User Datagram Protocol，用户数据报协议）；
4. 重要设备：**网关**。



### 网络层：逻辑寻址、路由选择

将数据传输到目标地址。目标地址可以是多个网络通过路由器连接而形成的某一个地址。因此这一层主要负责**寻址**和**路由选择**。

网络层的目的是**实现两个端系统之间的数据透明传送**，具体功能包括寻址和路由选择、连接的建立、保持和终止等。它提供的服务使传输层不需要了解网络中的数据传输和交换技术。

网络层中涉及众多的协议，其中包括最重要的协议，也是 TCP/IP 的核心协议 ——**IP 协议**。IP 协议非常简单，仅仅提供不可靠、无连接的传送服务。IP 协议的主要功能有：无连接数据报传输、数据报路由选择和差错控制。与 IP 协议配套使用实现其功能的还有地址解析协议 ARP、逆地址解析协议 RARP、因特网报文协议 ICMP、因特网组管理协议 IGMP。

有关网络层的重点为：
1. 网络层负责对子网间的数据包进行路由选择。此外，网络层还可以实现拥塞控制、网际互连等功能；
2. 基本数据单位为 **IP 数据报**；
3. 包含的主要协议：
    1. IP 协议（Internet Protocol，因特网互联协议）;
    2. ICMP 协议（Internet Control Message Protocol，因特网控制报文协议）;
    3. ARP 协议（Address Resolution Protocol，地址解析协议）;
    4. RARP 协议（Reverse Address Resolution Protocol，逆地址解析协议）。
4. 重要的设备：**路由器**。


### 数据链路层

负责物理层面上互联的、节点之间的通信传输。

在通过传输介质互连的设备之间传送和识别数据帧。

数据链路层在物理层提供的服务的基础上向网络层提供服务，其最基本的服务是**将源自网络层来的数据可靠地传输到相邻节点的目标机网络层**。

为达到这一目的，数据链路必须具备一系列相应的功能，主要有：如何将数据组合成数据块，在数据链路层中称这种数据块为帧（frame），帧是数据链路层的传送单位；如何控制帧在物理信道上的传输，包括如何处理传输差错，如何调节发送速率以使与接收方相匹配；以及在两个网络实体之间提供数据链路通路的建立、维持和释放的管理。数据链路层在不可靠的物理介质上提供可靠的传输。

该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等。

有关数据链路层的重要知识点：
1. 数据链路层为网络层提供可靠的数据传输；
2. 基本数据单位为**帧（frame）**；
3. 主要的协议：**以太网协议**；
4. 两个重要设备名称：**网桥**和**交换机**。

### 物理层

负责 0、1 比特流（0、1序列）与电压的高低、光的闪灭之间的互换。

激活、维持、关闭通信端点之间的机械特性、电气特性、功能特性以及过程特性。**该层为上层协议提供了一个传输数据的可靠的物理媒体**。简单的说，**物理层确保原始的数据可在各种物理媒体上传输**。 

两个重要设备：**中继器**（Repeater，也叫放大器）、**集线器**。



## 第2章：TCP/IP 协议


TCP/IP 协议群：
* 应用协议：HTTP、SMTP、FTP、TELNET、SNMP
* 传输协议：TCP、UDP
* 网际协议：IP、ICMP、ARP
* 路由控制协议：RIP、OSPF、BGP

### RFC 文档

* <https://www.rfc-editor.org/>
* <https://www.rfc-editor.org/rfc/>


### TCP/IP 协议分层模型

![TCP/IP 协议分层模型](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/TCP-IP%E5%88%86%E5%B1%82%E6%A8%A1%E5%9E%8B.png)


#### 硬件（物理层）

TCP/IP 的最底层是负责数据传输的硬件。这种硬件就相当于以太网或电话线路等物理层的设备。

#### 网络接口层（数据链路层）

* 网络接口层利用以太网中的数据链路层进行通信。
* 驱动程序是在操作系与硬件之间起桥梁作用等软件。

#### 互联网层（网络层）

* 互联网层使用 IP 协议。IP 协议基于 IP 地址转发分包数据。
* ICMP 用于 IP 数据包在发送途中发生异常时，给发送端发送异常通知。还用于诊断网络健康状况。
* ARP 协议：从分组数据包的 IP 地址中解析出物理地址（MAC 地址）。


#### 传输层

* TCP：面向有连接的传输层协议。
* UDP：面向无连接的传输层协议。


#### 应用层

* 在 TCP/IP 的分层中，将 OSI 参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现。
* WWW 中的 HTTP 属于 OSI **应用层**的协议，而 HTML 属于**表示层**的协议。
* 电子邮件协议：SMTP（Simple Mail Tranfer Protocol）。
* 文件传输：FTP
* 远程登录：TELNET、SSH
* 网络管理：SNMP


## 第3章：数据链路

数据链路层的协议定义了**通过通信媒介互连的设备之间传输的规范**。

MAC 寻址（物理寻址）、介质共享、非公有网络、分组交换、环路检测、VLAN（Virtual Local Area Network，虚拟局域网）...

* 数据链路，指 OSI 参考模型中的**数据链路层**，有时也指以太网、无线局域网等通信手段。
* TCP/IP 中对于 OSI 参考模型的数据链路层及以下部分（物理层）未做定义。因为 TCP/IP 以这两层的功能是透明的为前提。



### MAC 地址

* MAC 地址用于识别数据链路中互连的节点。
* 任何一个网卡的 MAC 地址都是唯一的，在全世界都不会有重复。
* Mac 地址长 48 比特，一般用十六进制数表示。


### 共享介质型网络

从通信介质的使用方法上看，网络可分为**共享介质型**和**非共享介质型**。

* 共享介质型：多个设备共享一个通信介质的一种网络。半双工通信。介质访问控制方式：争用方式/令牌传递。
* 非共享介质型：不共享介质。全双工通信。


### 环路检测技术

* 生成树方式；
* 源路由法；


### VLAN


### 以太网


### 无线通信

IEEE802.11、Wi-Fi、蓝牙、WiMAX、ZigBee（家电远程控制）


### PPP

* PPP（Point-to-Point Protocol）是点对点，即 1 对 1 连接计算机的协议。
* PPP 相当于 OSI 参考模型第 2 层的**数据链路层**。
* 互联网接入服务商在以太网上利用 PPPoE 提供 PPP 功能。


### ATM

* ATM 是以一个叫做**信元**（5字节首部加48字节数据）的单位进行传输的数据链路。
* ATM 是面向连接的一种数据链路。

### POS

* POS 是一种在 SDH 上进行包通信的一种协议。
* SDH 是在光线上传输数字信号的物理层规范。


### FDDI

FDDI 叫做分布式光线数据接口。

...


### 公共网络

介绍模拟电话线路、移动通信、ADSL、FTTP、有线电视、专线、VPN 以及公共无线 LAN 等内容。

#### 模拟电话线路

模拟电话线路就是利用固定电话线路进行通信。电话线中的音频带宽用于拨号上网。

让计算机与电话线相连需要有一个将**数字信号**转换为**模拟信号**的调制解调器（俗称“猫”）。“猫”的传输速率一般只有在 56kbps 左右，所以现在已逐渐被淘汰。


#### ADSL

对已有的模拟电话线路进行扩展的一种服务。

#### FTTH

FTTH 就是将一根**高速光纤**直接连接到用户家里或公司建筑物处的方法。它通过一个叫做 ONU 的装置将计算机与之关联。该装置负责在**光信号**与**电子信号**之间的转换。

使用 FTTH 可以实现稳定的高速通信。

光纤到户（FTTH）、光纤到楼（FTTB）、FTTC...


## 第4章：IP 协议

TCP/IP 的心脏是**互联网层**。这一层主要由 **IP** 和 **ICMP** 两个协议组成。

IP（IPv4、IPv6）相当于 OSI 参考模型中的第 3 层——**网络层**。

**数据链路层的作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输。**

IP 地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”。

### 路由控制

路由控制：将分组数据发送到最终目标地址的功能。

路由控制表的两种形成方式：

* 静态路由控制：管理员手动设置；
* 动态路由控制：路由器与其他路由器相互交换信息时自动刷新；

#### IP 报文的分片与重组

每种数据链路的最大传输单元（MTU）不同。

**路径 MTU 发现** 是指从发送端主机到接收端主机之间不需要分片时最大 MTU 的大小。即路径中存在的所有数据链路中最小的 MTU。
路径 MTU 发现从发送主机按照路径 MTU 的大小将数据报分片后进行发送。进行路径 MTU 发现，就可以避免在中途的路由器上进行分片处理，也可以在 TCP 中发送更大的包。

### 路由控制表

为了将数据包发送给目标主机，所有主机都维护着一张**路由控制表**（Routing Table）。该表记录 IP 数据在下一步应该发给哪个路由器。

### IP 地址的基础知识



**1）网络地址**

IP 地址由网络号（包括子网号）和主机号组成，网络地址的主机号为全 0，网络地址代表着整个网络。

**2）广播地址**

广播地址通常称为直接广播地址，是为了区分受限广播地址。

广播地址与网络地址的主机号正好相反，广播地址中，主机号为全 1。当向某个网络的广播地址发送消息时，该网络内的所有主机都能收到该广播消息。

**3）组播地址**

D 类地址就是组播地址。

先回忆下 A，B，C，D 类地址吧：

* A 类地址以 0 开头，第一个字节作为网络号，地址范围为：0.0.0.0~127.255.255.255；
* B 类地址以 10 开头，前两个字节作为网络号，地址范围是：128.0.0.0~191.255.255.255;
* C 类地址以 110 开头，前三个字节作为网络号，地址范围是：192.0.0.0~223.255.255.255。
* D 类地址以 1110 开头，地址范围是 224.0.0.0~239.255.255.255，D 类地址作为组播地址（一对多的通信）；
* E 类地址以 1111 开头，地址范围是 240.0.0.0~255.255.255.255，E 类地址为保留地址，供以后使用。

注：只有 A,B,C 有网络号和主机号之分，D 类地址和 E 类地址没有划分网络号和主机号。

**4）255.255.255.255**

该 IP 地址指的是受限的广播地址。受限广播地址与一般广播地址（直接广播地址）的区别在于，**受限广播地址只能用于本地网络**，路由器不会转发以受限广播地址为目的地址的分组；一般广播地址既可在本地广播，也可跨网段广播。例如：主机 192.168.1.1/30 上的直接广播数据包后，另外一个网段 192.168.1.5/30 也能收到该数据报；若发送受限广播数据报，则不能收到。

注：一般的广播地址（直接广播地址）能够通过某些路由器（当然不是所有的路由器），而受限的广播地址不能通过路由器。

**5）0.0.0.0**

常用于寻找自己的 IP 地址，例如在我们的 RARP，BOOTP 和 DHCP 协议中，若某个未知 IP 地址的无盘机想要知道自己的 IP 地址，它就以 255.255.255.255 为目的地址，向本地范围（具体而言是被各个路由器屏蔽的范围内）的服务器发送 IP 请求分组。

**6）回环地址**

127.0.0.0/8 被用作回环地址，**回环地址表示本机的地址**，常用于对本机的测试，用的最多的是 127.0.0.1。

**7）A、B、C 类私有地址**

私有地址 (private address) 也叫专用地址，它们不会在全球使用，只具有本地意义。

* A 类私有地址：10.0.0.0/8，范围是：10.0.0.0~10.255.255.255
* B 类私有地址：172.16.0.0/12，范围是：172.16.0.0~172.31.255.255
* C 类私有地址：192.168.0.0/16，范围是：192.168.0.0~192.168.255.255




## 第5章：IP 协议相关技术

介绍作为 IP 的辅助和扩展规范的 DNS、ARP、ICMP、NAT 以及 DHCP 等协议。还包括如 IP 隧道、IP 多播、IP 任播、质量控制（QoS）以及网络拥塞的显式通知和 Mobile IP 技术。


### DNS

系统在自动将主机名转换为具体的 IP 地址时，会使用一个叫做 hosts 的数据库文件。

**DNS 系统**可以维护一个用来表示组织内部主机名和 IP 地址之间对应关系的数据库。

进行 DNS 查询的主机和软件叫做 **DNS 解析器**。

**域名**是指为了识别主机名称和组织机构名称的一种具有分层的名称。


### ARP

ARP 以目标 IP 地址为线索，用来定位下一个应该接收数据分包的网络设备对应的 Mac 地址。

ARP 只适用于 IPv4，不适用于 IPv6。在 IPv6 中可以用 **ICMPv6** 替代 ARP 发送邻居探索消息。

ARP 的工作机制：ARP 借助 **ARP 请求**与 **ARP 响应**两种类型的包确定 Mac 地址。





### RARP

RARP 是将 ARP 反过来，从 MAC 地址定位 IP 地址的一种协议。

### ICMP

网络诊断。

ICMP 的主要功能：确认 IP 包是否成功送达目标地址，通知在发送过程当中 IP 包被废弃的具体原因，改善网络设置等。

ICMP 消息大致可以分为两类：

1. 通知错误原因的错误消息；
2. 用于诊断的查询消息；


### DHCP

DHCP 动态主机设置协议（Dynamic Host Configuration Protocol）是一个局域网的网络协议，使用 UDP 协议工作，主要有两个用途：给内部网络或网络服务供应商自动分配 IP 地址，给用户或者内部网络管理员作为对所有计算机作中央管理的手段。

自动设置 IP 地址、统一管理 IP 地址分配。

DHCP 中继代理

### NAT

NAT （Network Address Translator）是用于在本地网络中使用私有地址，在连接互联网时使用全局 IP 地址的技术。

私有 IP 地址结合 NAT 技术已成为现在解决 IP 地址分配问题的主流方案。

NAT 网络地址转换 (Network Address Translation) 属接入广域网 (WAN) 技术，是一种将私有（保留）地址转化为合法 IP 地址的转换技术，它被广泛应用于各种类型 Internet 接入方式和各种类型的网络中。原因很简单，NAT 不仅完美地解决了 lP 地址不足的问题，而且还能够有效地避免来自网络外部的攻击，隐藏并保护网络内部的计算机。


#### NAT-PT

NAT-PT 是将 IPv6 的首部转换为 IPv4 的首部的一种技术。实现在 IPv4 和 IPv6 之间相互通信。

### IP 隧道

IP 隧道：在网络层的首部后面继续追加网络层首部的通信方法。


### 路由选择协议

常见的路由选择协议有：RIP 协议、OSPF 协议。

**RIP 协议**：底层是贝尔曼福特算法，它选择路由的度量标准（metric) 是跳数，最大跳数是 15 跳，如果大于 15 跳，它就会丢弃数据包。

**OSPF 协议**：Open Shortest Path First 开放式最短路径优先，底层是迪杰斯特拉算法，是链路状态路由选择协议，它选择路由的度量标准是带宽，延迟。



## 第6章：TCP 与 UDP

* TCP 是面向连接的、可靠的流协议。流是指不间断的数据结构。
* UDP 是不具有可靠性的数据报协议。
* TCP 提供可靠传输的机制：**检验和**、**序列号**、**确认应答（ACK）**、**重发控制**、**连接管理**、**窗口控制**、**拥塞控制（慢启动算法）**等。
* UDP 主要用于对**高速传输**和**实时性**有较高要求的通信或**广播通信**。


> 传输协议（TCP/UDP）需要硬件供应商的支持，并且需要大多数网络运营商的部署才能普及。由于此事涉及的成本和工作量，运营商们不愿进行更新。以 IPv6 为例：它是 24 年前推出的，但如今距离获得普遍支持还有很远的距离。
> 
> HTTP3 背后的主要思想是放弃 TCP，转而使用基于 UDP 的 QUIC 协议。
> 
> 与 HTTP2 在技术上允许未加密的通信不同，QUIC 严格要求加密后才能建立连接。


### 端口号

**端口号**用来识别同一台计算机中进行通信的不同**应用程序**。因此，它也被称为**程序地址**。

TCP/IP 或 UDP/IP 通信中通常采用 5 个信息来识别一个通信。它们是：

* 源 IP 地址；
* 目标 IP 地址；
* 协议号；
* 源端口号；
* 目标端口号；

端口号的确定方式：
* 静态方法：每个应用程序都有其指定的端口号。
* 时许分配法：操作系统分配。

服务名称和传输协议端口号注册表：
[Service Name and Transport Protocol Port Number Registry](https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)


### UDP

UDP 协议是一种面向无连接的传输层协议，不会关注数据是否到达对端。多用在数据少或多播、广播通信、视频通信等多媒体领域。

UDP 的首部：

![](https://user-gold-cdn.xitu.io/2017/12/12/1604b4917a0c314f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

* 源端口号：表示发送的端口号，字段长 16 位。该字段是可选项，有时可能不会设置源端口号。没有源端口号的时候该字段的值设置为 0，可用于不需要返回的通信中。
* 目标端口号：表示接收端口号，字段长 16 位。
* 包长度：UDP 首部的长度和 UDP 数据长度之和（单位位字节）
* 校验和：用来判断数据在传输过程中是否损坏，除了检验 UDP 首部的源端口号、目标端口号，还包括源 IP 地址、目标 IP 地址、协议号（这三个也叫 “UDP 伪首部”）。原因是识别一个通信必须包括这 5 大因素，假如 UDP 伪首部出来问题，极有可能应该收包的应用收不到包。



### TCP

TCP 协议是一种面向连接的传输层协议，要连接和断开经过“三次握手，四次挥手”，可以保证数据传输的可达，具备可靠性。能处理丢包、传输数据顺序乱的问题，还有通过流控制有效地利用宽度，缓解网络拥堵的作用。

![](https://user-gold-cdn.xitu.io/2017/12/12/1604b4917702553b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

* 源端口号：表示发送的端口号，字段长 16 位。
* 目标端口号：表示接收端口号，字段长 16 位。
* 序列号：指发送数据的位置，字段长 32 位，每发送一次数据就累加一次该数据字节数的大小。序列号是在建立连接时由计算机随机生成的随机数作为初始值，通过 SYN 包传给接收端。
* 确认应答号：它等于下一次应该接收到的数据的序列号。假设发送端的序列号为 s，发送数据的长度为 l，那么接收端返回的确认应答号也是 s + l。发送端接收到这个确认应答后，可以认为这个位置以前所有的数据都已被正常接收。
* 数据偏移：该字段表示 TCP 所传输的数据部分应该从 TCP 包的哪个位开始计算，也就是 TCP 首部的长度。该字段的长度单位为 4 字节，如果没有可选字段，那么这里的值就是 5，表示 TCP 首部的长度为 20 字节。
* 保留：该字段主要为了以后扩展是使用，其长度位 4 位。一般设置位 0，但即使收到的包的在该字段不为 0，此包也不会被丢弃。
* 控制位：改字段长度为 8 比特，分别有 8 个控制标志。依次是 CWR，ECE，URG，ACK，PSH，RST，SYN 和 FIN。
  * CWR（Congestion Window Reduced）：CWR 与 ECE 都用于 IP 地址首部的 ECN 字段。ECE 标志为 1 是，则通知对方已将拥堵窗口缩小。
  * ECE（ECN-Echo）: 为 1 时，通知对方，从对方到这边有网络拥塞的情况。
  * URG（Urgent Flag）：为 1 时，表示包中有需要紧急处理的数据。
  * ACK（Acknowledgement Flag）： 为 1 时，确认应答的字段变为有效。TCP 规定处理最初建立连接是的     * SYN 包之外该为必须设置为 1。
  * PSH（Push Flag）：为 1 时，表示需要将收到的数据立刻传给上层应用协议。PSH 为 0 是则不用立即传是先进行缓存。
  * RST（Reset Flag）：为 1 时，表示 TCP 连接中出现一次必须强制断开连接。例如，一个没有被使用的端口即使发来连接请求，也无法进行通信，这时可以返回一个 RET 为 1 的包，端口连接。
  * SYN（Synchronize Flag）：用于建立连接。SYN 为 1 表示希望建立连接，并在其序列号的字段进行序列号初始值的设定，建立连接的 双方，序列号和趣儿应答号要保持同步。
  * FIN（Fin Flag）：为 1 时，表示今后不会再有数据发送，希望断开连接。通信双方的主机之间通过发送 FIN 位置为 1 的 TCP 段，且每个主机对对方的 FIN 包进行确认应答以后就可以断开连接。不过，不用马上作出应答，而是等缓存区的所有数据发送完成后再发确认应答。
* 窗口大小：该字段长 16 位，用于通知从相同 TCP 首部确认应答号所指位置开始能够接收的数据到小。有一种情况，窗口大小为 0 时，则表示发送窗口探测，以了解最新的窗口大小。但这个数据必须为 1 字节。
* 校验和：TCP 的校验和与 UDP 相似，区别在于 TCP 的校验和无法关闭。
* 紧急指针：该字段为 16 位，只有在 URG 控制位为 1 是才有效。
* 选项：该字段用于提高 TCP 的传输性能。





### TCP 连接的建立与断开

![](https://tva1.sinaimg.cn/large/0081Kckwgy1glhlvzgvctj30j80hvaa9.jpg)


![三次握手](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/025236.png)

注：seq:"sequance" 序列号；ack:"acknowledge" 确认号；SYN:"synchronize" 请求同步标志；ACK:"acknowledge" 确认标志；FIN："Finally" 结束标志。

#### TCP 三次握手

TCP 握手一般由客户端发起，步骤如下：

1. 第一次握手：客户端发送一个 TCP 的 SYN 标志位置 1 的包指明客户打算连接的服务器的端口，以及初始序号 X, 保存在包头的序列号 (Sequence Number) 字段里，并进入 SYN_SEND 状态，等待服务器确认。
2. 第二次握手：服务器发回确认包 (ACK) 应答。即 SYN 标志位和 ACK 标志位均为 1 同时，将确认序号 (Acknowledgement Number) 设置为 X+1, 服务器进入 SYN_RECV 状态。
3. 第三次握手：客户端再次发送确认包 (ACK) SYN 标志位为 0，ACK 标志位为 1. 并且把服务器发来 ACK 的序号字段 + 1, 放在确定字段中发送给对方。

在三次握手过程中，服务器发送 SYN-ACK 之后，收到客户端的 ACK 之前的 TCP 连接称为半连接 (half-open connect)。此时服务器处于 SYN_RECV 状态。当收到 ACK 后，服务器转入 ESTABLISHED 状态。

为什么是三次握手？
因为 TCP 的可靠的数据传输，且是全双工通信，在双方进行数据传输前，必须确认双方都可以接收数据。例如：如果是二次握手就建立，当服务端给客户端发送数据时，由于没有第三次的 ACK 握手，服务端就不确定客户端能否接收到数据。如果同样给客户端发送数据，就会造成资源的浪费。

#### 四次挥手

![](https://user-gold-cdn.xitu.io/2019/2/17/168fab9d0765320d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

1. 客户端主动关闭，向服务端发送 FIN 包，包首部 FIN=1,seq (序列号) = u, 进入 FIN-WAIT 状态。
2. 服务端收到客户端的 FIN 包后，向客服端发送一个 ACK 包，包首部 ACK=1,seq = v,ack = u+1，进入等待关闭状态。
3. 等服务端的缓存数据全部发送完时向客服端发送一个 FIN 包，包首部 FIN=1,ACK=1,seq=w,ack=u+1, 进入 Last-Ack 状态，等待客户端的回复再关闭。
4. 客服端收到服务端的 FIN 包后，返回一个 ACK 包，包的首部 ACK=1,seq=u+1,ack = w+1, 服务端收到 ACK 后就关闭 TCP 连接，而客户端进入等待关闭，等待 2MSL 的时间后没有收到服务端的数据，再关闭连接。



总结一下 HTTP 建立连接、终止连接：

* TCP 协议需要通过三次握手建立可靠连接。
* 想要建立 HTTPS 安全连接，需要在 TCP 可靠连接基础上使用 TLS 协议。TLS 协议需要四次握手才能建立安全连接。
* 终止 TCP 可靠连接时需要四次挥手。

需要注意的是，本文所说的三次握手、七次握手、四次挥手都是基于特定版本的协议，不同版本的协议所需握手次数可能不同。HTTP/3 就是一个例子，它使用基于 UDP 的 QUIC 协议进行握手，将 TCP 和 TLS 握手过程结合起来，握手次数从七次减少到了三次。


### UDP-Lite

UDP-Lite（轻量级用户数据报协议），扩展 UDP 机能的一种传输层协议，在基于 UDP 的通信当中如果**校验和**出现错误，所收到的包将被全部丢弃。

### SCTP

SCTP（流控制传输协议）与 TCP 一样，都是对一种提供数据到达与否相关可靠性检查的传输层协议。

SCTP 主要用于进行通信的应用之间发送众多较小消息的情况。这些较小的应用消息被称作数据块（Chunk），多个数据块组成一个数据包。

SCTP 具有支持多重宿主（同一台主机具备多种网络接口）以及设定多个 IP 地址的特点。

### DCCP

DCCP（数据报拥塞协议）是一个辅助 UDP 的崭新的传输层协议。添加**拥塞控制**功能。



## 第7章：路由协议

介绍路由控制以及实现路由控制功能的相关协议。

### IP 与路由控制

路由器根据路由控制表（Routing Table）转发数据包。

静态路由与动态路由：
* 静态路由：事先设置好路由器和主机中并将路由信息固定的一种方法。
* 动态路由：让路由协议在运行过程中自动设置路由控制信息。


路由协议大致分为两类：
* 外部网关协议（IGP）；RIP（路由信息协议）、RIP2、OSPF（开放式最短路径优先）等；
* 内部网关协议（EGP）；BGP（边界网关协议）；

自治系统（路由选择域）内部动态路由采用的协议是**域内路由协议**，即 IGP。而自治系统之间的路由控制采用的是**域间路由协议**，即 EGP。


### 路由算法

距离向量算法、链路状态算法、


### MPLS

在转发 IP 数据包的过程中除了使用**路由技术**外，还在使用**标记交换技术**。路由技术基于 IP 地址中最长匹配原则进行转发，而标记交换则对每个 IP 包都设定一个叫做“标记”的值，然后根据这个“标记”再进行转发。

标记交换技术中最具代表性的当属**多协议标记交换技术**，即 MPLS。


## 第八章：应用协议


### 远程登录：TELNET/SSH

TELNET 利用 TCP 的一条连接，通过这一条连接向主机发送文字命令并在主机上执行。
TELNET 经常用于登录**路由器**或**高性能交换机**等网络设备进行相应的设置。

SSH 是加密的远程登录系统。
SSH 可以加密通信内容，即使信息被窃听也无法破解所发送的密码、具体命令以及命令返回的结果是什么。


### 文件传输：FTP

FTP 是在两个相连的计算机之间进行文件传输时使用的协议。
FTP 使用两条 TCP 连接：一条用来控制、另一条用于数据（文件）传输。


### 电子邮件：SMTP、MIME、POP、IMAP

早期电子邮件是在发送端主机与接收端主机之间直接建立 TCP 连接进行邮件传输。

接收端从**邮件服务器**接收邮件时使用 POP3 协议。


### WWW：URI、HTML、HTTP

* URI 用于标识资源。
* HTML 是记述 Web 页面的一种语言。
* HTTP 的工作机制：客户端向服务器的 80 端口建立一个 TCP 连接，然后在这个 TCP 连接上进行请求和应答以及数据报文的发送。
* HTTP 1.0 中每一个命令和应答都会触发一次 TCP 连接的建立和断开。而从 HTTP 1.1 开始，允许在一个 TCP 连接上发送多个命令和应答（keep-alive）。


### 网络管理：SNMP、MIB、RMON

[MRTG](https://oss.oetiker.ch/mrtg/) 是利用 RMON 定期收集网络中路由器的网络流量信息的工具。

> Multi Router Traffic Grapher------MRTG 是一个监控网络链路流量负载的工具软件，通过 snmp 协议得到设备的流量信息，并将流量负载以包含 PNG 格式的图形的 HTML 文档方式显示给用户，以非常直观的形式显示流量负载。


## 第9章：网络安全


网络安全最基本的要领是**要有预备方案**。

防火墙、IDS（入侵检测系统）、反病毒/个人防火墙、

从功能上看，IDS 有定期采集日志、长期监控、通知异常等功能。


### 加密技术与 OSI 参考模型


| 分层 | 加密技术 |
| --- | --- |
| 应用层 | SSH、SSL-Telnet、PET 等远程登录、PGP、S/MIME 等加密邮件 |
| 表示层、传输层 | SSL/TLS、SOCKET V5 加密 |
| 网络层 |  IPsec|
| 数据链路层 | Ethernet、VAN 加密装置、PPTP |




## 参考

* [图解 TCP/IP（第 5 版）](https://book.douban.com/subject/24737674/)
* [Poll 的笔记：计算机网络基础知识总结](https://www.cnblogs.com/maybe2030/p/4781555.html)
