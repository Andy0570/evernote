### 什么是基于口令的密码

**基于口令的密码**（Password Based Encryption，PBE）是一种根据口令生成密钥并用该密钥进行加密的方法。其中加密和解密使用同一个密钥。

### 用于加密内容的加密和用于加密密钥的加密

* CEK（Contents Encrypting Key，内容加密密钥）：加密的对象是用户直接使用的信息（内容）。
* KEK（Key Encrypting Key，密钥加密密钥）：用于加密密钥的密钥。

![用于加密内容的加密和用于加密密钥的加密](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/CEK%20%E5%92%8C%20KEK.png)

### PBE 加密

PBE 加密流程：
1. 生成 KEY；
2. 生成会话密钥并加密；
3. 加密消息；

![PBE 加密](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/PBE.png)

#### 1. 生成 KEK

首先，伪随机数生成器会生成一个被称之为盐（salt）的随机数。将盐和 Alice 输入的口令一起输入单向散列函数，得到的散列值就是用来加密密钥的密钥（KEK）。

正如在饭菜上撒盐会改变饭菜的味道一样，在口令中加盐就会改变所生成的 KEK 值。盐是一种用于防御字典攻击的机制。

#### 2. 生成会话密钥并加密

接下来，使用伪随机数生成器生成一个会话密钥（session key）。会话密钥是用来加密消息的密钥（CEK）。

会话密钥需要用第一步生成的 KEK 进行加密，和盐一起保存在安全的地方。会话密钥被加密之后，KEK 就会被丢弃，因为 KEK 没有必要保存下来，只要通过盐和口令就可以重建 KEK。

#### 3. 加密消息

最后，使用第二步生成的会话密钥加密消息。

PBE 加密后所产生的输出包括下列三种：
* 盐；
* 用 KEK 加密的会话密钥；
* 用会话密钥加密的消息；

其中 “盐” 和 “用 KEK 加密的会话密钥” 需要保存在安全的地方。

### PBE 解密

PBE 解密流程：
1. 生成 KEY；
2. 生成会话密钥并加密；
3. 加密消息；

![](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/PBE-1.png)


#### 1. 重建 KEK

首先将之前保存下来的盐，和 Alice 输入的口令一起输入单向散列函数。这个计算过程和生成 KEK 时的计算过程是一样的，因此所得到的散列值就是 KEK。

#### 2. 解密会话密钥

然后，我们获取之前保存下来的 “用 KEK 加密的会话密钥”，用步骤 1 中恢复的 KEK 进行解密。这一步可以得到会话密钥。

#### 3. 解密消息

最后，用步骤 2 中重建的会话密钥对加密的消息进行解密。

在 PBE 解密过程中，没有使用到伪随机数生成器。

### 盐的作用

盐是由伪随机数生成器生成的随机数，在生成密钥（KEK）时会和口令一起被输入单向散列函数。

即：盐 + 口令 生成 KEK密钥

密钥（KEK）是根据秘密的口令生成的，加盐好像没有什么意义，那么盐到底起到什么作用呢？

**盐可以用来防御字典攻击**。字典攻击是一种事先进行计算并准备好候选密钥列表的方法。

我们假设在生成 KEK 时没有加盐。那么主动攻击者就可以根据字典数据事先生成大量的候选 KEK。

在这里，事先是很重要的。这意味着攻击者可以在窃取到加密的会话密钥之前，就准备好大量的候选 KEK。当攻击者窃取加密的会话密钥后，就需要尝试将它解密，这时只要利用事先生成的候选 KEK, 就能够大幅缩短尝试的时间，这就是字典攻击。

如果在生成 KEK 时加盐，则盐的长度越大，候选 KEK 的数量也会随之增大，事先生成候选 KEK 就会变得非常困难。只要攻击者没有得到盐，就无法生成候选 KEK。这是因为加盐之后，候选 KEK 的数量会变得非常巨大。

![加盐和不加盐的字典攻击对比](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/image.png)


### 口令的作用

有这样一个事实：具有充足长度的密钥是无法用人脑记忆的。口令也是一样，我们也无法记住具有充足比特数的口令。

在 PBE 中，通过口令生成密钥（KEK），再用这个密钥来加密会话密钥（CEK）。由于通过口令生成的密钥（KEK）强度不如用伪随机数生成器生成的会话密钥（CEK），这就好像是将一个牢固的保险柜钥匙放在一个不怎么牢固的保险柜中保管。

因此在使用基于口令的密码（PBE）时，需要将盐和加密后的 CEK **通过物理方式进行保护**。例如可以将盐和加密后的 CEK 保存到存储卡中随身携带。

### 通过拉伸来改良 PBE

**在生成 KEK 时，可以通过多次使用单向散列函数来提高安全性**。例如，如果将盐和口令先输入单向散列函数，然后将得到的散列函数再次输入单向散列函数，将得到的散列值再次输入单向散列函数...... 像这样经过 1000 次散列函数所得到的散列值作为 KEK 来使用，是一个不错的方法。

对于用户来说，执行 1000 次散列函数并不会带来多大的负担，因为和用户输入一次口令所花费的时间相比，执行 1000 次散列函数所需的时间可以忽略不计。然而，对于主动攻击者来说，这可是一个很大的负担。因为为了找出正确的 KEK，攻击者必须用大量的口令进行尝试。

像这样将单向散列函数进行多次迭代的方法称为拉伸。


### 如何生成安全的口令

当我们在计算机上登录时，需要输入口令。通过输入口令，我们可以证明自己拥有登录这台计算机的权利。

在将用 PBE 加密的文章进行解密时，我们也需要输入口令。这个过程也是通过输入口令来证明自己拥有解密该文章的权利。

口令是非常重要的，但是要生成安全的口令却是非常难的。

下面介绍一些生成安全口令的小技巧。

#### 使用只有自己才知道的信息

在生成口令时，**使用只有自己才能知道的信息**是一个大原则。因为口令不能够被别人推测出来，因此使用只有自己才能知道的信息是理所当然的。

##### 不用使用对自己重要的事物的名字

由于口令非常重要，很多人往往会使用对自己重要的事物的名字。例如，自己恋人的名字、配偶的名字、孩子的名字、宠物的名字、偶像的名字、车的名字、品牌的名字。然而，对自己重要的事物的名字反而是容易被别人推测出来的信息，因此我们不应该在口令中使用这些名字。

##### 不要使用关于自己的信息

不要在口令中使用像自己的名字、自己登录用户名、地址、员工号码等和自己相关的信息。

##### 不要使用别人见过的信息

不要使用一些别人可能看到过的信息作为口令、例如名言、有名的引文、字典的例句、网上看到的话、键盘上的字母顺序、彩虹的颜色、行星的名字、星座、月份、星期等。

这样一看，只有自己才知道的信息真的是非常有限的，因此生成一个安全的密码其实并不容易。

#### 将多个不同的口令分开使用

不用将同一个口令重复用于各种不同的用途，而是应该根据信息的价值区分使用不同的口令。例如，用来在网上阅读新闻的口令，和用来加密包含 1000 个客户信息的重要文件的口令显然不能用同一个。

在区分使用口令时，不能仅仅改变口令的一部分。比如说下面这样的做法就是**不可以的**。

登录公司计算机的口令：TGBYHN**1**
登录家里计算机的口令：TGBYHN**2**
用于邮件数字签名的口令：TGBYHN**3**
网上购物用的口令：TGBYHN**4**

这样的话，只要破译其中一个口令，其他的口令就很容易被推测出来。

😂😂😂
这个方法以前我也使用过很长一段时间，我的密码格式是这样的：
`固定一段需要记忆的密码@平台名称`

比如说：
QQ 密码：abced@qq
微信密码：abcde@weixin
微博密码：abced@sina
163密码：abcde@163
...

#### 有效利用笔记

不可以将口令写在便签上然后贴在计算机的屏幕上，特别是在人来人往的办公室里更是严禁这种行为。

不过，有效利用笔记也并不是坏事。与其以好记忆为理由设置一个简单的口令，还不如用伪随机数生成器生成一个随机的字符串作为口令，然后将口令记下来保存在安全的地方。换言之，应该将笔记与物理的钥匙同等对待。仅将口令的一部分写下来的方法也是非常有效的。

#### 理解口令的局限性

口令是有局限性的。为了说起来简单，我们假设口令只能由 8 个字符的英文字母和数字组成。英文字母和数字一同有 62 个，因此 8 个英文字母和数字组合的可能性为：

`62^8=218340105584896`

也就是大约 218 万亿种。这个数字虽然不小，但实际上只不过相对于一个长度为 48 比特的密钥而已。这个长度的密钥是可以通过暴力破解的。如果攻击者的计算机每秒可以生成并尝试 1 亿个口令，则只需要 25 天就可以遍历所有的口令了。

#### 使用口令生成和管理工具

如果靠人自己来生成和管理口令可以说是非常困难的。

如今，我们要使用的网站非常多，其中大部分都需要使用用户名和口令来登录。为了解决人类难以直接管理口令这个现实问题，就需要一些能够帮助我们生成和管理口令的工具。

![](https://blog-andy0570-1256077835.cos.ap-shanghai.myqcloud.com/site_Images/FB9526C7D9CB606797F20C16E43B32B0.png)

这些工具通过随机数来生成难以推测的口令，并能够与浏览器联动在网站上自动输入相应的口令。

不过，我们也必须提防这些工具擅自盗用用户的口令，也就是说，这些工具以及开发者是否 “可信” 是非常重要的。


## 参考

* 《图解密码技术》结城浩[日]著

